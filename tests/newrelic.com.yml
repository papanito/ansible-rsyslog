---
- hosts: localhost
  gather_facts: no

  pre_tasks:
  - name: Create a basic test server
    hcloud_server:
      name: ansible-test
      server_type: cx11
      image: debian-10
      state: started
      ssh_keys: 
        - ansible-user
        - aedu-clawfinger
    delegate_to: localhost
    register: result

  - name: Store ipv4 of host
    set_fact:
      test_server_ipv4: "{{ result.hcloud_server.ipv4_address }}"

- hosts: ansible-test
  remote_user: root
  vars:
    rsyslog_srv: newrelic.com
    rsyslog_tls: true
    rsyslog_tag: syslog
    rsyslog_token: !vault |
      $ANSIBLE_VAULT;1.1;AES256
      33623039616334323363306563383162353339326366623136316165313438323864666462663933
      3761643235356139366539323964363265656537366639330a326233326136643938343434353536
      37383439393335323536353637353263623135383133336538323030626432373034336339343730
      3837326463633436640a383034653762343964323462313461356438343639323032373163393732
      61633030333361323666353062383932623661663265336138343561386161323636653539656536
      3563383835303562323434373766316361393565303735393834
    rsyslog_additional_config:
      - "authpriv.*      /var/log/auth.log"
  roles:
    - ../ansible-role-rsyslog

- hosts: localhost
  gather_facts: no
  vars:
    stop_server: false

  pre_tasks:
  - name: Shutdown test server
    hcloud_server:
      name: ansible-test
      state: stopped
    delegate_to: localhost
    when: stop_server is defined and stop_server